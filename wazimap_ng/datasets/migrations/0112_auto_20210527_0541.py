# Generated by Django 2.2.13 on 2021-05-27 05:41

from django.db import migrations
from django.db.models import Count


def remove_dubplicate_groups(apps, schema_editor):
    Dataset = apps.get_model("datasets", "Dataset")

    for dataset in Dataset.objects.all():
        groups = dataset.group_set.all()

        for group in groups.values("name").annotate(gc=Count("name")):
            if group["gc"] > 1:
                filtered_group = groups.filter(name=group["name"])
                subindicators = []
                for g in filtered_group:
                    subindicators = subindicators + g.subindicators

                first = filtered_group.first()
                first.subindicators = list(set(subindicators))
                filtered_group.exclude(id=first.id).delete()


class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0111_auto_20210322_0740'),
    ]

    operations = [
        migrations.RunPython(remove_dubplicate_groups),
    ]
